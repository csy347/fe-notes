title: Stream流.md
date: 2018-06-06 14:37:00
categories: Node
tags: Stream

---

## 1. 流的概念

* 流是一组有序的，有起点和终点的字节数据传输手段
* 它不关心文件的整体内容，只关注是否从文件中读到了数据，以及读到数据之后的处理
* 流是一个抽象接口，被Node中的很多对象所实现。比如HTTP服务器request和response对象都是流

## 2. 可读流 createReadStream

```js
let fs = require('fs');
let rs = fs.createReadStream(path);
rs.setEncoding('utf8');
rs.on('open', callback);
rs.on('data', callback);
setTimeout(()=>{
  rs.resume();
}, 1000);
rs.on('end', callback);
```

## 3. 可写流 createWriteStream

可写流有缓存区的概念

1. 第一次写入的是真的向文件里写，第二次再写入的时候是放到缓存区里
2. 写入时会返回一个boolean类型，返回为false时不要再写入了
3. 当内存和正在写入的内容消耗完后，会触发一个事件 drain

```js
let fs = require('fs');
let ws = fs.createWriteStream('./2.txt', {
    flags: 'w',         // 文件夹不存在会创建
    encoding: 'utf8',   // 文件里存放的都是二进制
    highWaterMark: 3,   // 设置当前缓存区的大小
    mode: 0o666,        // 可读可写
    autoClose: true,    // 自动关闭
    start: 0,
});
// drain的触发时机，只有当higeWaterMark填满时，才可能触发drain
// 当嘴里的和地下的都吃完了，就会触发drain方法
let i = 9;
function write() {
    let flag = true;
    while (flag && i>=0) {
      i--;
      flag = ws.write("1"); // 987 // 654 // 321 // 0
      console.log(flag);
    }
}
write();
ws.on('drain', () => {
    console.log('干净了');
    write();
});
```


## 4. pipe方法

## 5. 简单实现

---

[来源](https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000/001434501515527e6fce6d5ec4b4fd9b572122cd1ec8ded000)

[来源](https://zhufengzhufeng.github.io/201802/html/13.Stream-1.html)
